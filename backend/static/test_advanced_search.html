<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级搜索测试 - 小雪宝AI助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 页面标题 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">🔍 高级知识库搜索测试</h1>
                <p class="text-gray-600">测试增强版知识库搜索功能</p>
            </div>

            <!-- 搜索界面 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">搜索测试</h2>
                
                <!-- 基础搜索 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜索关键词：</label>
                    <div class="flex space-x-2">
                        <input type="text" id="searchInput" class="flex-1 p-3 border border-gray-300 rounded-md" 
                               placeholder="例如：白血病、化疗、营养" onkeydown="handleSearchKeyDown(event)">
                        <button onclick="testRegularSearch()" class="bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600">
                            常规搜索
                        </button>
                        <button onclick="testSmartSearch()" class="bg-purple-500 text-white px-6 py-3 rounded hover:bg-purple-600">
                            智能搜索
                        </button>
                    </div>
                </div>

                <!-- 高级选项 -->
                <div class="grid md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分类筛选：</label>
                        <select id="categoryFilter" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">全部分类</option>
                            <option value="疾病知识">疾病知识</option>
                            <option value="治疗护理">治疗护理</option>
                            <option value="心理健康">心理健康</option>
                            <option value="营养指导">营养指导</option>
                            <option value="家长支持">家长支持</option>
                            <option value="生活指导">生活指导</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最低相关度：</label>
                        <select id="minScoreFilter" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="0">不限制</option>
                            <option value="1">1分以上</option>
                            <option value="2">2分以上</option>
                            <option value="3">3分以上</option>
                        </select>
                    </div>
                </div>

                <!-- 快捷搜索 -->
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">快捷搜索：</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickSearch('白血病')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">白血病</button>
                        <button onclick="quickSearch('化疗')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">化疗</button>
                        <button onclick="quickSearch('营养')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">营养</button>
                        <button onclick="quickSearch('心理')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">心理</button>
                        <button onclick="quickSearch('症状')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">症状</button>
                        <button onclick="quickSearch('家长')" class="text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full">家长</button>
                    </div>
                </div>

                <!-- 分类浏览 -->
                <div>
                    <p class="text-sm text-gray-600 mb-2">分类浏览：</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <button onclick="testCategorySearch('疾病知识')" class="text-sm bg-red-100 hover:bg-red-200 p-2 rounded text-left">🏥 疾病知识</button>
                        <button onclick="testCategorySearch('治疗护理')" class="text-sm bg-green-100 hover:bg-green-200 p-2 rounded text-left">💊 治疗护理</button>
                        <button onclick="testCategorySearch('心理健康')" class="text-sm bg-blue-100 hover:bg-blue-200 p-2 rounded text-left">🧘 心理健康</button>
                        <button onclick="testCategorySearch('营养指导')" class="text-sm bg-yellow-100 hover:bg-yellow-200 p-2 rounded text-left">🍎 营养指导</button>
                        <button onclick="testCategorySearch('家长支持')" class="text-sm bg-purple-100 hover:bg-purple-200 p-2 rounded text-left">👨‍👩‍👧‍👦 家长支持</button>
                        <button onclick="testCategorySearch('生活指导')" class="text-sm bg-pink-100 hover:bg-pink-200 p-2 rounded text-left">🏠 生活指导</button>
                    </div>
                </div>
            </div>

            <!-- 搜索结果 -->
            <div id="searchResult" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">搜索结果</h3>
                    <div id="searchResponse"></div>
                </div>
            </div>

            <!-- API测试 -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-8">
                <h2 class="text-xl font-semibold mb-4">API测试</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <button onclick="testGetCategories()" class="bg-green-500 text-white p-3 rounded hover:bg-green-600">
                        获取所有分类
                    </button>
                    <button onclick="testGetKeywords()" class="bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">
                        获取热门关键词
                    </button>
                </div>
                <div id="apiResult" class="mt-4 hidden">
                    <h4 class="font-semibold mb-2">API响应：</h4>
                    <div id="apiResponse" class="bg-gray-50 p-4 rounded border"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 处理回车键搜索
        function handleSearchKeyDown(event) {
            if (event.key === 'Enter') {
                testRegularSearch();
            }
        }

        // 快捷搜索
        function quickSearch(query) {
            document.getElementById('searchInput').value = query;
            testSmartSearch();
        }

        // 常规搜索测试
        async function testRegularSearch() {
            const input = document.getElementById('searchInput');
            const resultDiv = document.getElementById('searchResult');
            const responseDiv = document.getElementById('searchResponse');
            const categoryFilter = document.getElementById('categoryFilter');
            const minScoreFilter = document.getElementById('minScoreFilter');
            const query = input.value.trim();

            if (!query) {
                alert('请输入搜索关键词');
                return;
            }

            try {
                responseDiv.innerHTML = '<div class="text-blue-500">常规搜索中...</div>';
                resultDiv.classList.remove('hidden');

                // 构建搜索URL
                let searchUrl = `/api/v1/knowledge/search?q=${encodeURIComponent(query)}&limit=5`;
                if (categoryFilter.value) {
                    searchUrl += `&category=${encodeURIComponent(categoryFilter.value)}`;
                }
                if (minScoreFilter.value) {
                    searchUrl += `&min_score=${minScoreFilter.value}`;
                }

                const response = await fetch(searchUrl);
                const result = await response.json();

                displaySearchResults(result, '🔍 常规搜索结果', 'blue');

            } catch (error) {
                console.error('搜索失败:', error);
                responseDiv.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded">搜索失败：${error.message}</div>`;
            }
        }

        // 智能搜索测试
        async function testSmartSearch() {
            const input = document.getElementById('searchInput');
            const resultDiv = document.getElementById('searchResult');
            const responseDiv = document.getElementById('searchResponse');
            const query = input.value.trim();

            if (!query) {
                alert('请输入搜索关键词');
                return;
            }

            try {
                responseDiv.innerHTML = '<div class="text-purple-500">智能搜索中...</div>';
                resultDiv.classList.remove('hidden');

                const response = await fetch(`/api/v1/knowledge/smart-search?q=${encodeURIComponent(query)}&limit=5`);
                const result = await response.json();

                displaySmartSearchResults(result);

            } catch (error) {
                console.error('智能搜索失败:', error);
                responseDiv.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded">智能搜索失败：${error.message}</div>`;
            }
        }

        // 分类搜索测试
        async function testCategorySearch(category) {
            const resultDiv = document.getElementById('searchResult');
            const responseDiv = document.getElementById('searchResponse');

            try {
                responseDiv.innerHTML = `<div class="text-green-500">加载分类 "${category}" 中...</div>`;
                resultDiv.classList.remove('hidden');

                const response = await fetch(`/api/v1/knowledge/category/${encodeURIComponent(category)}`);
                const result = await response.json();

                displayCategoryResults(result, category);

            } catch (error) {
                console.error('分类搜索失败:', error);
                responseDiv.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded">分类搜索失败：${error.message}</div>`;
            }
        }

        // 显示搜索结果
        function displaySearchResults(result, title, color) {
            const responseDiv = document.getElementById('searchResponse');
            
            let html = `
                <div class="bg-${color}-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-2 text-${color}-800">${title}</h4>
                    <div class="text-sm text-${color}-600">
                        查询词：${result.data.query} | 
                        结果数：${result.data.total} | 
                        搜索时间：${result.data.search_time}秒
                    </div>
                </div>
            `;

            if (result.success && result.data.results.length > 0) {
                html += '<div class="space-y-3">';

                result.data.results.forEach((item, index) => {
                    html += `
                        <div class="border border-${color}-200 rounded-lg p-4 hover:border-${color}-400 transition-colors bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-lg text-gray-800">${item.title}</h5>
                                <span class="text-xs bg-${color}-500 text-white px-2 py-1 rounded">${item.category}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${item.content}</p>
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span class="font-medium">相关度：${item.relevance_score}</span>
                                <span>关键词：${item.keywords.join(', ')}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            } else {
                html += '<div class="text-gray-500 p-4 bg-gray-50 rounded">未找到相关结果</div>';
            }

            responseDiv.innerHTML = html;
        }

        // 显示智能搜索结果
        function displaySmartSearchResults(result) {
            const responseDiv = document.getElementById('searchResponse');
            
            let html = `
                <div class="bg-purple-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-2 text-purple-800">🧠 智能搜索结果</h4>
                    <div class="text-sm text-purple-600">
                        查询词：${result.data.query} | 
                        结果数：${result.data.total_results} | 
                        搜索时间：${result.data.search_time}秒
                    </div>
                </div>
            `;

            if (result.success && result.data.results.length > 0) {
                // 搜索结果
                html += '<div class="space-y-3 mb-4">';
                result.data.results.forEach((item, index) => {
                    html += `
                        <div class="border border-purple-200 rounded-lg p-4 hover:border-purple-400 transition-colors bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-lg text-gray-800">${item.title}</h5>
                                <span class="text-xs bg-purple-500 text-white px-2 py-1 rounded">${item.category}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${item.content}</p>
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span class="font-medium">智能评分：${item.relevance_score}</span>
                                <span>关键词：${item.keywords.join(', ')}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                // 搜索建议
                if (result.data.suggestions && result.data.suggestions.length > 0) {
                    html += `
                        <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                            <h5 class="font-medium mb-2 text-yellow-800">💡 搜索建议</h5>
                            <div class="flex flex-wrap gap-2">
                    `;
                    result.data.suggestions.forEach(suggestion => {
                        html += `<button onclick="document.getElementById('searchInput').value='${suggestion}'; testSmartSearch();" class="text-sm bg-yellow-100 hover:bg-yellow-200 px-3 py-1 rounded-full border border-yellow-300">${suggestion}</button>`;
                    });
                    html += '</div></div>';
                }

                // 相关分类
                if (result.data.related_categories && result.data.related_categories.length > 0) {
                    html += `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-medium mb-2 text-green-800">📂 相关分类</h5>
                            <div class="flex flex-wrap gap-2">
                    `;
                    result.data.related_categories.forEach(cat => {
                        html += `<button onclick="testCategorySearch('${cat.category}')" class="text-sm bg-green-100 hover:bg-green-200 px-3 py-1 rounded-full border border-green-300">${cat.category} (${cat.item_count}条)</button>`;
                    });
                    html += '</div></div>';
                }

            } else {
                html += '<div class="text-gray-500 p-4 bg-gray-50 rounded">未找到相关结果</div>';
            }

            responseDiv.innerHTML = html;
        }

        // 显示分类结果
        function displayCategoryResults(result, category) {
            const responseDiv = document.getElementById('searchResponse');
            
            let html = `
                <div class="bg-green-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-2 text-green-800">📁 分类浏览：${category}</h4>
                    <div class="text-sm text-green-600">
                        分类：${result.data.category} | 
                        内容数：${result.data.total} | 
                        搜索时间：${result.data.search_time}秒
                    </div>
                </div>
            `;

            if (result.success && result.data.results.length > 0) {
                html += '<div class="space-y-3">';

                result.data.results.forEach((item, index) => {
                    html += `
                        <div class="border border-green-200 rounded-lg p-4 hover:border-green-400 transition-colors bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-lg text-gray-800">${item.title}</h5>
                                <span class="text-xs bg-green-500 text-white px-2 py-1 rounded">${item.category}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${item.content}</p>
                            <div class="text-xs text-gray-500">
                                <span>关键词：${item.keywords.join(', ')}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            } else {
                html += '<div class="text-gray-500 p-4 bg-gray-50 rounded">该分类下暂无内容</div>';
            }

            responseDiv.innerHTML = html;
        }

        // 测试获取分类
        async function testGetCategories() {
            const resultDiv = document.getElementById('apiResult');
            const responseDiv = document.getElementById('apiResponse');

            try {
                responseDiv.innerHTML = '获取分类中...';
                resultDiv.classList.remove('hidden');

                const response = await fetch('/api/v1/knowledge/categories');
                const result = await response.json();

                responseDiv.innerHTML = `<pre class="text-sm overflow-x-auto">${JSON.stringify(result, null, 2)}</pre>`;

            } catch (error) {
                responseDiv.innerHTML = `<div class="text-red-500">获取分类失败：${error.message}</div>`;
            }
        }

        // 测试获取关键词
        async function testGetKeywords() {
            const resultDiv = document.getElementById('apiResult');
            const responseDiv = document.getElementById('apiResponse');

            try {
                responseDiv.innerHTML = '获取关键词中...';
                resultDiv.classList.remove('hidden');

                const response = await fetch('/api/v1/knowledge/keywords?limit=10');
                const result = await response.json();

                responseDiv.innerHTML = `<pre class="text-sm overflow-x-auto">${JSON.stringify(result, null, 2)}</pre>`;

            } catch (error) {
                responseDiv.innerHTML = `<div class="text-red-500">获取关键词失败：${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
