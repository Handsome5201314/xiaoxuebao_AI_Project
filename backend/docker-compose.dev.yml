version: '3.8'

services:
  # 小雪宝后端API服务 (开发模式)
  xiaoxuebao-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: xiaoxuebao-api-dev
    ports:
      - "8000:8000"
    environment:
      # 数据库配置 (使用SQLite进行快速开发)
      - DATABASE_URL=sqlite:///./xiaoxuebao.db
      
      # Redis配置 (可选，使用内存缓存)
      - REDIS_URL=redis://redis:6379/0
      
      # 安全配置
      - SECRET_KEY=dev-secret-key-change-in-production
      - JWT_SECRET=dev-jwt-secret-change-in-production
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      
      # 应用配置
      - APP_NAME=小雪宝AI助手
      - APP_VERSION=1.0.0
      - DEBUG=true
      - TESTING=false
      
      # CORS配置
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8080,http://localhost:8000
      
      # 日志配置
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=text
      
      # 性能配置
      - WORKERS=1
      - MAX_CONNECTIONS=50
      
      # 缓存配置
      - CACHE_TTL=300
      - CACHE_MAX_SIZE=100
      
      # 限流配置
      - RATE_LIMIT_REQUESTS=1000
      - RATE_LIMIT_WINDOW=60
      
      # 文件上传配置
      - MAX_FILE_SIZE=10485760  # 10MB
      - UPLOAD_PATH=/app/uploads
    
    volumes:
      - .:/app
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    
    depends_on:
      - redis
    
    networks:
      - xiaoxuebao-dev-network
    
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis 缓存 (轻量级配置)
  redis:
    image: redis:7-alpine
    container_name: xiaoxuebao-redis-dev
    command: >
      redis-server 
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    
    ports:
      - "6379:6379"
    
    networks:
      - xiaoxuebao-dev-network
    
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# 网络
networks:
  xiaoxuebao-dev-network:
    driver: bridge
