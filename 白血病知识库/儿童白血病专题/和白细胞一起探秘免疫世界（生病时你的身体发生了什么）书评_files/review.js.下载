!function(n){function e(r){if(t[r])return t[r].exports;var o=t[r]={exports:{},id:r,loaded:!1};return n[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var t={};return e.m=n,e.c=t,e.p="",e(0)}([function(module,exports,__webpack_require__){eval("'use strict';\n\nvar _vote = __webpack_require__(3);\n\nvar _vote2 = _interopRequireDefault(_vote);\n\nvar _ad_insert = __webpack_require__(4);\n\nvar _ad_insert2 = _interopRequireDefault(_ad_insert);\n\nvar _replace = __webpack_require__(2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n(function () {\n  var adInsert = new _ad_insert2.default();\n  if (document.readyState !== 'loading') {\n    (0, _vote2.default)(document);\n  } else if (document.addEventListener) {\n    document.addEventListener('DOMContentLoaded', function () {\n      var content = document.querySelector('.review-content');\n      if (content) {\n        (0, _replace.replaceTopicContent)(content);\n      }\n      (0, _vote2.default)(document);\n      $('.comment-item').each(function (index, ele) {\n        // 长评回复 4 位展示信息流广告\n        if (index === 2) {\n          $(ele).after(adInsert.html());\n        }\n      });\n    }, false);\n  } else {\n    window.attachEvent('onreadystatechange', function () {\n      if (document.readyState !== 'loading') {\n        (0, _vote2.default)(document);\n      }\n    });\n  }\n  window.onload = function () {\n    adInsert.getAd();\n  };\n})(); /* global reviewObj */\n\n// index page js\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/review.js\n// module id = 0\n// module chunks = 0\n//# sourceURL=webpack:///./src/js/review.js?")},,function(module,exports){eval("'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.replaceHashTag = replaceHashTag;\nexports.replaceHashTagInDom = replaceHashTagInDom;\nexports.replaceTopicContent = replaceTopicContent;\n/**\n * 替换正文中的内容\n */\n\n/**\n * #内容# 替换为 <a href=\"https://www.douban.com/search?q=#内容#\">#内容#</a>\n * @param text\n * @returns\n */\nfunction replaceHashTag(text) {\n  var regex = /#([^#]+)#/g;\n  if (!regex.test(text)) {\n    return text;\n  }\n  return text.replace(regex, function (match, p1) {\n    var query = encodeURIComponent('#' + p1 + '#');\n    return '#<a href=\"https://www.douban.com/search?q=' + query + '\">' + p1 + '</a>#';\n  });\n}\n\n/**\n * 替换 dom 中的 #内容# 为 <a href=\"https://www.douban.com/search?q=#内容#\">#内容#</a>\n * @param dom\n */\nfunction replaceHashTagInDom(dom) {\n  var nodes = dom.childNodes;\n  var _iteratorNormalCompletion = true;\n  var _didIteratorError = false;\n  var _iteratorError = undefined;\n\n  try {\n    for (var _iterator = nodes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n      var node = _step.value;\n\n      if (node.nodeType === Node.TEXT_NODE) {\n        // 替换 text node\n        var text = node.textContent;\n        if (!text) {\n          continue;\n        }\n        var hashTagString = replaceHashTag(text);\n        if (hashTagString === text) {\n          continue;\n        }\n        var tempNode = document.createElement('div');\n        tempNode.innerHTML = hashTagString;\n        var fragment = document.createDocumentFragment();\n        while (tempNode.firstChild) {\n          fragment.appendChild(tempNode.firstChild);\n        }\n        if (node.parentNode) {\n          node.parentNode.replaceChild(fragment, node);\n        }\n      }\n    }\n  } catch (err) {\n    _didIteratorError = true;\n    _iteratorError = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion && _iterator.return) {\n        _iterator.return();\n      }\n    } finally {\n      if (_didIteratorError) {\n        throw _iteratorError;\n      }\n    }\n  }\n}\n\n/**\n * 替换帖子正文中的内容\n */\nfunction replaceTopicContent(dom) {\n  var paragraphNodes = dom.querySelectorAll('p');\n  var _iteratorNormalCompletion2 = true;\n  var _didIteratorError2 = false;\n  var _iteratorError2 = undefined;\n\n  try {\n    for (var _iterator2 = paragraphNodes[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n      var paragraphNode = _step2.value;\n\n      replaceHashTagInDom(paragraphNode);\n    }\n  } catch (err) {\n    _didIteratorError2 = true;\n    _iteratorError2 = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion2 && _iterator2.return) {\n        _iterator2.return();\n      }\n    } finally {\n      if (_didIteratorError2) {\n        throw _iteratorError2;\n      }\n    }\n  }\n}\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/_replace.js\n// module id = 2\n// module chunks = 0\n//# sourceURL=webpack:///./src/js/_replace.js?")},function(module,exports){eval("'use strict';\n\n/* global $, alert, get_cookie */\n\nvar initVote = function initVote() {\n  var CONST_REVIEW_VOTE = {\n    'useful_count': ['有用', '/j/review/{REVIEW_ID}/useful'],\n    'useless_count': ['没用', '/j/review/{REVIEW_ID}/useless'],\n    'spoiler': ['剧透提醒已提交，谢谢', '/j/review/{REVIEW_ID}/spoiler']\n  };\n\n  var regDisabled = /disabled/,\n      regVoteType = /(\\w+_count)/,\n      regSpoiler = /spoiler/,\n      ck = get_cookie('ck');\n\n  var votePanels = document.querySelectorAll('.main-panel-useful'),\n      votePanel = null,\n      rid = '';\n\n  var isAuthor = function isAuthor(votePanel) {\n    return votePanel && votePanel.getAttribute('data-is_owner') === 'true';\n  };\n\n  var canVote = function canVote(votePanel) {\n    return votePanel && votePanel.getAttribute('data-can_vote') === 'true';\n  };\n\n  var isTV = function isTV(votePanel) {\n    return votePanel && votePanel.getAttribute('data-is_tv') === 'true';\n  };\n\n  var handleVote = function handleVote(e) {\n    if (!ck) {\n      return;\n    }\n    e.stopPropagation();\n    if (window._USER_ABNORMAL) {\n      window.show_abnormal && window.show_abnormal();\n      return;\n    }\n\n    var target = e.target;\n    var cn = target.className;\n    var match = cn.match(regVoteType) || cn.match(regSpoiler);\n    var type = '';\n    var API_VOTE = '';\n    var voteTxt = '';\n\n    if (cn.match(regDisabled)) {\n      return;\n    }\n\n    if (match) {\n      if (isAuthor(e.currentTarget)) {\n        return alert('不能给自己投票噢');\n      }\n\n      if (!canVote(e.currentTarget)) {\n        var txt = isTV(e.currentTarget) ? '该剧尚未播出，不能投票噢' : '该电影还未上映，不能投票噢';\n        return alert(txt);\n      }\n\n      type = match[0]; // 'useful', 'useless', 'spoiler'\n      voteTxt = CONST_REVIEW_VOTE[type][0];\n      API_VOTE = CONST_REVIEW_VOTE[type][1];\n      rid = e.currentTarget.getAttribute('data-rid');\n      API_VOTE = API_VOTE.replace('{REVIEW_ID}', rid);\n    } else if (!match || !rid) {\n      return;\n    }\n\n    var voteReq = $.post(API_VOTE, { 'ck': ck }, function (res) {\n      if (res.r == 0) {\n        if (type === 'spoiler') {\n          return handleSpoiler();\n        }\n        countVote(res, type);\n      }\n    });\n\n    voteReq.fail(function () {\n      alert('网络错误');\n    }).always(function () {\n      // console.log('vote ')\n    });\n  };\n\n  var handleSpoiler = function handleSpoiler(type) {\n    // 在 列表 中，通过 `review-${rid}-content` 寻找对应的节点\n    var reviewElem = document.getElementById('review-' + rid + '-content') || document.getElementById(rid);\n    var spoilerElem = reviewElem.querySelector('.spoiler');\n    spoilerElem.innerText = CONST_REVIEW_VOTE['spoiler'][0];\n    spoilerElem.className = spoilerElem.className.replace('not-reported', 'disabled');\n  };\n\n  var countVote = function countVote(res, type) {\n    var reviewElem = document.getElementById('review-' + rid + '-content') || document.getElementById(rid);\n    for (var i in CONST_REVIEW_VOTE) {\n      if (res[i] !== undefined) {\n        var countTxt = CONST_REVIEW_VOTE[i][0] + ' ' + res[i];\n        var countElem = reviewElem.querySelector('.' + i);\n        var _cn = countElem.className;\n\n        // 从没投过票 || 已经投票过\n        if (i === type) {\n          countElem.classList.add('disabled');\n        } else {\n          countElem.classList.remove('disabled');\n        }\n        countElem.innerHTML = countTxt;\n      }\n    }\n  };\n\n  var len = votePanels.length;\n  if (len === 1) {\n    votePanel = votePanels[0];\n    rid = votePanel.getAttribute('data-rid');\n    votePanel && votePanel.addEventListener('click', handleVote, false);\n  } else {\n    for (var i = 0; i < len; i++) {\n      votePanel = votePanels[i];\n      votePanel && votePanel.addEventListener('click', handleVote, false);\n    }\n  }\n};\n\nmodule.exports = initVote;\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/_vote.js\n// module id = 3\n// module chunks = 0\n//# sourceURL=webpack:///./src/js/_vote.js?")},function(module,exports){eval("'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/**\n * copy frodo/talion/static/js/card\n */\n\nvar DEFAULT_SLOTS = ['dale_movie_review_comment_feed'];\n\nvar DEFAULT_CONFIG = {\n  name: 'AdInsert',\n  slots: DEFAULT_SLOTS\n};\n\nvar AdInsert = function () {\n  function AdInsert() {\n    var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : DEFAULT_CONFIG;\n\n    _classCallCheck(this, AdInsert);\n\n    var name = config.name,\n        slots = config.slots;\n\n    this.current = slots[0];\n    this.name = name;\n    this.slots = slots || [];\n  }\n\n  _createClass(AdInsert, [{\n    key: 'html',\n    value: function html() {\n      var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var _config$tag = config.tag,\n          tag = _config$tag === undefined ? 'div' : _config$tag,\n          _config$className = config.className,\n          className = _config$className === undefined ? 'Theme-item Advertisement' : _config$className,\n          _config$style = config.style,\n          style = _config$style === undefined ? '' : _config$style,\n          _config$postFix = config.postFix,\n          postFix = _config$postFix === undefined ? '' : _config$postFix;\n\n      var slotName = this.current;\n      var slotDiv = '<' + tag + ' class=\"' + className + '\" id=\"' + slotName + '\" style=\"' + style + '\"></' + tag + '>';\n      return slotDiv;\n    }\n  }, {\n    key: 'getAd',\n    value: function getAd() {\n      var slotName = this.current;\n      if (window.getDoubanAD) {\n        try {\n          var slots = this.slots;\n          var slotNameIndex = slots.indexOf(slotName);\n          var nextSlotIndex = slots.length > slotNameIndex + 1 ? slotNameIndex + 1 : 0;\n          var nextSlotName = slots[nextSlotIndex];\n          window.getDoubanAD(slotName);\n          this.current = nextSlotName;\n        } catch (e) {\n          console && console.log(e);\n        }\n      }\n    }\n  }]);\n\n  return AdInsert;\n}();\n\nexports.default = AdInsert;\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/ad_insert.js\n// module id = 4\n// module chunks = 0\n//# sourceURL=webpack:///./src/js/ad_insert.js?")}]);